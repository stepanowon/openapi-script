** 슬라이드 36

package com.multi.bitlyclient.util;

public class Settings {
  public static final String CLIENT_ID = 
             "[발급받은 client_id]";
  public static final String CLIENT_SECRET = 
             "[발급받은 client_secret]";
  public static final String AUTHORIZE_URL=
             "https://bitly.com/oauth/authorize";
  public static final String ACCES_TOKEN_URL = 
             "https://api-ssl.bitly.com/oauth/access_token";
  public static final String REDIRECT_URI = 
             "http://jcornor.com:8000/callback";
  public static final String SHORTEN_API_URL = 
             "https://api-ssl.bitly.com/v4/shorten";
}


** 슬라이드 37

package com.multi.bitlyclient;
......
@Controller
@RequestMapping(value = "/")
public class IndexController {

  @GetMapping
  public String requestIndex(Model model) {
    HashMap<String, String> map = new HashMap<String, String>();
    map.put("client_id", Settings.CLIENT_ID);
    map.put("redirect_uri", Settings.REDIRECT_URI);
    map.put("response_type", "code");
    String url = Settings.AUTHORIZE_URL + "?" + OAuth2ClientUtil.getParamStringFromMap(map);
    model.addAttribute("url", url);
    return "index";
  }
}

------
[ src/main/resources/templates/index.html 파일 ]

<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>bitly Oauth 2.0 client Test</title>
</head>
<body>
  <a th:href="@{${url}}">bitly 앱 승인 페이지로 이동</a>
  <br /><br /><br />
  <p>반드시 http://jcornor.com:8000 로 실행하세요.</p>
</body>
</html>


** 슬라이드 39

package com.multi.bitlyclient;
......
@Controller
@RequestMapping(value="/callback")
public class CallbackController {
  
  @GetMapping()
  public String requestCallback(HttpSession session, Model model, 
      @RequestParam(value = "code") String code)
      throws ClientProtocolException, IOException {
    HttpPost httpPost = new HttpPost(Settings.ACCES_TOKEN_URL);

    ArrayList<NameValuePair> nameValuePairs = new ArrayList<NameValuePair>();
    nameValuePairs.add(new BasicNameValuePair("client_id", Settings.CLIENT_ID));
    nameValuePairs.add(new BasicNameValuePair("client_secret", Settings.CLIENT_SECRET));
    nameValuePairs.add(new BasicNameValuePair("redirect_uri", Settings.REDIRECT_URI));
    nameValuePairs.add(new BasicNameValuePair("grant_type", "authorization_code"));
    nameValuePairs.add(new BasicNameValuePair("code", code));
    httpPost.setEntity(new UrlEncodedFormEntity(nameValuePairs, StandardCharsets.UTF_8));
    CloseableHttpClient httpClient = HttpClientBuilder.create().build();
    CloseableHttpResponse response = httpClient.execute(httpPost);

    String body = "";

    if (response.getStatusLine().getStatusCode() == 200) {
      ResponseHandler<String> handler = new BasicResponseHandler();
      body = handler.handleResponse(response);
        HashMap<String,String> tokenMap = OAuth2ClientUtil.getMapFromParamString(body);
        session.setAttribute("access_token", tokenMap.get("access_token"));
        return "redirect:/main";
    } else {
      model.addAttribute("message", "인증실패");
      model.addAttribute("body", body);
    }
    return "error";
  }
}


** 슬라이드 41

package com.multi.bitlyclient;
……
@Controller
@RequestMapping(value="/main")
public class MainController {
  @GetMapping()
  public String requestMain(HttpSession session) {
    if (session.getAttribute("access_token") == null) 
      return "redirect:/";
    return "main";
  }
}

//  src/main/resources/templates/main.html 페이지도 함께 검토하세요.



** 슬라이드 42

<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Quicksand" />
	<link rel="stylesheet" type="text/css" href="css/pretty-json.css" />
	<title>URL 단축 테스트</title>
</head>

<body>
	긴 URL : <input type="text" id="long" value="" /><br />
	<button id="shorten">URL 짧게!!</button>
	<hr />
	짧은 URL : <span id="short"></span><br />
	수신 데이터 : <br />
	<div style="border: solid 1px gray;" id="json">
		&nbsp;
	</div>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/underscore-min.js"></script>
	<script type="text/javascript" src="js/backbone-min.js"></script>
	<script type="text/javascript" src="js/pretty-json-min.js"></script>
	<script type="text/javascript">
		var param = {longUrl: ""};
		$("#shorten").click(function () {
			param.long_url = $("#long").val();
			$.get("shorten", param, function (response) {
				var node = new PrettyJSON.view.Node({
					el: $("#json"),
					data: response
				});
				console.log(response);
				$("#short").html(response.link);
			});
		})
	</script>
</body>
</html>


** 슬라이드 43
package com.multi.bitlyclient;
......
@Controller
@RequestMapping(value = "/shorten")
public class ShortenController {
  
  @GetMapping()
  public void requestMain(HttpSession session, HttpServletResponse res, 
      @RequestParam(value = "long_url") String long_url) throws Exception {
    if (session.getAttribute("access_token") == null) {
      throw new Exception("access_token is null");
    }
    String access_token = (String) session.getAttribute("access_token");
    String bearerToken = OAuth2ClientUtil.generateBearerTokenHeaderString(access_token);

    HttpPost httpPost = new HttpPost(Settings.SHORTEN_API_URL);
    httpPost.setHeader("Authorization", bearerToken);
    httpPost.setHeader("Content-type", "application/json");
    httpPost.setHeader("Accept", "application/json");
    String json = "{ \"long_url\" : \"" + long_url + "\" } ";
    HttpEntity postEntity = new StringEntity(json, "UTF-8");
    httpPost.setEntity(postEntity);

    CloseableHttpClient httpClient = HttpClientBuilder.create().build();
    CloseableHttpResponse response = httpClient.execute(httpPost);

    String result = "";
    int statusCode = response.getStatusLine().getStatusCode();
    if (statusCode == 200 ||  statusCode == 201) {
      ResponseHandler<String> handler = new BasicResponseHandler();
      result = handler.handleResponse(response);
      System.out.println(result);
    } else {
      result = "{ \"status\" : \"오류 발생 : " + response.getStatusLine().getStatusCode() + "\" }";
    }
    res.setContentType("application/json");
    res.getWriter().print(result);
    res.getWriter().close();
  }
}


** 슬라이드 51

server.port=80

#data source settings
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

------
keytool -genkeypair -alias oauth2-sample -keyalg RSA -keystore oauth2-sample.pfx -storetype PKCS12



** 슬라이드 52

DROP TABLE oauth2_authorization;
DROP TABLE oauth2_registered_client;
DROP TABLE oauth2_authorization_consent;
DROP TABLE authorities;
DROP TABLE users;

CREATE TABLE oauth2_authorization_consent (
    registered_client_id varchar(100) NOT NULL,
    principal_name varchar(200) NOT NULL,
    authorities varchar(1000) NOT NULL,
    PRIMARY KEY (registered_client_id, principal_name)
);

CREATE TABLE oauth2_registered_client (
    id varchar(100) NOT NULL,
    client_id varchar(100) NOT NULL,
    client_id_issued_at timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
    client_secret varchar(200) DEFAULT NULL,
    client_secret_expires_at timestamp DEFAULT NULL,
    client_name varchar(200) NOT NULL,
    client_authentication_methods varchar(1000) NOT NULL,
    authorization_grant_types varchar(1000) NOT NULL,
    redirect_uris varchar(1000) DEFAULT NULL,
    post_logout_redirect_uris varchar(1000) DEFAULT NULL,
    scopes varchar(1000) NOT NULL,
    client_settings varchar(2000) NOT NULL,
    token_settings varchar(2000) NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE oauth2_authorization (
    id varchar(100) NOT NULL,
    registered_client_id varchar(100) NOT NULL,
    principal_name varchar(200) NOT NULL,
    authorization_grant_type varchar(100) NOT NULL,
    authorized_scopes varchar(1000) DEFAULT NULL,
    attributes blob DEFAULT NULL,
    state varchar(500) DEFAULT NULL,
    authorization_code_value blob DEFAULT NULL,
    authorization_code_issued_at timestamp DEFAULT NULL,
    authorization_code_expires_at timestamp DEFAULT NULL,
    authorization_code_metadata blob DEFAULT NULL,
    access_token_value blob DEFAULT NULL,
    access_token_issued_at timestamp DEFAULT NULL,
    access_token_expires_at timestamp DEFAULT NULL,
    access_token_metadata blob DEFAULT NULL,
    access_token_type varchar(100) DEFAULT NULL,
    access_token_scopes varchar(1000) DEFAULT NULL,
    oidc_id_token_value blob DEFAULT NULL,
    oidc_id_token_issued_at timestamp DEFAULT NULL,
    oidc_id_token_expires_at timestamp DEFAULT NULL,
    oidc_id_token_metadata blob DEFAULT NULL,
    refresh_token_value blob DEFAULT NULL,
    refresh_token_issued_at timestamp DEFAULT NULL,
    refresh_token_expires_at timestamp DEFAULT NULL,
    refresh_token_metadata blob DEFAULT NULL,
    user_code_value blob DEFAULT NULL,
    user_code_issued_at timestamp DEFAULT NULL,
    user_code_expires_at timestamp DEFAULT NULL,
    user_code_metadata blob DEFAULT NULL,
    device_code_value blob DEFAULT NULL,
    device_code_issued_at timestamp DEFAULT NULL,
    device_code_expires_at timestamp DEFAULT NULL,
    device_code_metadata blob DEFAULT NULL,
    PRIMARY KEY (id)
);


CREATE TABLE users (
    id BIGINT NOT NULL AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    password VARCHAR(200) DEFAULT NULL,
    enabled BOOLEAN NOT NULL,
    acc_locked BOOLEAN NULL,
    acc_expired BOOLEAN NULL,
    creds_expired BOOLEAN NULL,
    PRIMARY KEY (id)
);

CREATE TABLE authorities (
    id BIGINT NOT NULL AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    authority VARCHAR(200) NOT NULL,
    PRIMARY KEY (id)
);



** 슬라이드 53

package com.multi.oauth20server;

......(import 문 생략)

@Configuration
@EnableWebSecurity
public class SpringSecurityConfig {

	private final DataSource dataSource;

	// 생성자를 이용해 Data Source 의존성 주입
	public SpringSecurityConfig(DataSource dataSource) {
		this.dataSource = dataSource;
	}

	// 사용자 password를 일방향 암호화하기 위한 Bean 설정
	@Bean
	PasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder();
	}

	/**
	 * * oauth 인증과정중 사용자 로그인을 위한 jdbc를 이용 사용자 서비스 - data source를 사용하는
	 * jdbcUserDetailsMananer Bean을 리턴하면 됨 - try~catch 문의 코드는 다른 Bean을 이용해 사용자를 등록할
	 * 때 사용하면 됨
	 */
	@Bean
	UserDetailsService userDetailsService() {
		JdbcUserDetailsManager jdbcUserDetailsManager = new JdbcUserDetailsManager(dataSource);

		try {
			jdbcUserDetailsManager.loadUserByUsername("user1");
		} catch (UsernameNotFoundException ex) {
			UserDetails user = User.builder().username("user1").password(passwordEncoder().encode("1234")).roles("USER")
					.build();
			jdbcUserDetailsManager.createUser(user);
		}

		return jdbcUserDetailsManager;
	}

	// 1. 사용자 인증을 위한 UserDetailsService를 이용하도록 설정
	// 2. Password 인코더로 BCryptPasswordEncoder 사용
	@Bean
	DaoAuthenticationProvider authenticationProvider(UserDetailsService userDetailsService) {
		DaoAuthenticationProvider auth = new DaoAuthenticationProvider(userDetailsService);
		auth.setPasswordEncoder(passwordEncoder());
		return auth;
	}

	/**
	 * * 보안 설정 - AuthorizationServerConfiguration에서 기본 보안설정을 적용할 것이므로 여기서는 모든 요청에 대해
	 * 인증을 요구하는 것으로 설정해도 됨 - FormLogin을 Default로 설정
	 */
	@Bean
	@Order(2)
	SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
		http.authorizeHttpRequests(
				authorize -> authorize.requestMatchers("/assets/**", "/webjars/**", "/login", "/error").permitAll()
						.anyRequest().authenticated())
				.formLogin(Customizer.withDefaults());

		return http.build();
	}
}


** 슬라이드 57

package com.multi.oauth20server;
......(import문 생략)

@Configuration
public class AuthorizationServerConfig {

	@Autowired
	PasswordEncoder passwordEncoder;

	/**
	 * * AuthorizationServer 보안 필터 적용 - SpringSecurityConfig의
	 * defaultSecurityFilterChain Bean보다 로드 우선순위를 높여야 함 - OAuth2.0 기본 보안 설정 적용 -
	 * oidc 지원 및 사용자 인증은 formLogin을 이용하도록 설정함
	 */
	@Bean
	@Order(Ordered.HIGHEST_PRECEDENCE)
	SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {
		OAuth2AuthorizationServerConfigurer authorizationServerConfigurer = new OAuth2AuthorizationServerConfigurer();

		http.securityMatcher(authorizationServerConfigurer.getEndpointsMatcher())
				.authorizeHttpRequests(authorize -> authorize.anyRequest().authenticated())
				.csrf(csrf -> csrf.ignoringRequestMatchers(authorizationServerConfigurer.getEndpointsMatcher()))
				.with(authorizationServerConfigurer, authServer -> authServer.oidc(Customizer.withDefaults()))
				// 인증 실패 시 로그인 페이지로 리다이렉트 추가
				.exceptionHandling(exceptions -> exceptions.authenticationEntryPoint(
						new org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint("/login")))
				// Form 로그인 추가 (옵션)
				.formLogin(Customizer.withDefaults());

		return http.build();
	}

	/**
	 * Json Web Key 셋을 생성함.
	 */
	private JWKSet buildJWKSet() throws KeyStoreException, NoSuchAlgorithmException, CertificateException,
			FileNotFoundException, IOException {
		char[] keystorePassword = "123456".toCharArray();
		KeyStore keyStore = KeyStore.getInstance("pkcs12");
		try (FileInputStream fis = new FileInputStream("src/main/resources/oauth2-sample.pfx")) {
			keyStore.load(fis, keystorePassword);
			return JWKSet.load(keyStore, name -> keystorePassword);
		}
	}

	/**
	 * JWKSource 생성 (Spring Boot 4)
	 */
	@Bean
	JWKSource<SecurityContext> jwkSource() throws NoSuchAlgorithmException, KeyStoreException, CertificateException,
			FileNotFoundException, IOException {
		JWKSet jwkSet = buildJWKSet();
		return new ImmutableJWKSet<>(jwkSet);
	}

	/**
	 * JWT 디코더 설정 (Spring Boot 4)
	 */
	@Bean
	JwtDecoder jwtDecoder(JWKSource<SecurityContext> jwkSource) {
		return NimbusJwtDecoder.withJwkSource(jwkSource).build();
	}

	/**
	 * AuthorizationServer 설정 (Spring Boot 4)
	 */
	@Bean
	AuthorizationServerSettings authorizationServerSettings() {
		return AuthorizationServerSettings.builder().issuer("http://tfactory.com").build();
	}

	/**
	 * JWT 토큰 설정
	 */
	@Bean
	TokenSettings tokenSettings() {
		return TokenSettings.builder().accessTokenTimeToLive(Duration.ofMinutes(15))
				.refreshTokenTimeToLive(Duration.ofHours(3)).reuseRefreshTokens(false).build();
	}

	/**
	 * 클라이언트 설정
	 */
	@Bean
	ClientSettings clientSettings() {
		return ClientSettings.builder().requireProofKey(false).requireAuthorizationConsent(true).build();
	}

	/**
	 * 클라이언트 앱 정보를 jdbc로 조회하도록 설정
	 */
	@Bean
	RegisteredClientRepository registeredClientRepository(JdbcTemplate jdbcTemplate) {
		JdbcRegisteredClientRepository jdbcRegisteredClientRepository = new JdbcRegisteredClientRepository(
				jdbcTemplate);

		RegisteredClient client1 = jdbcRegisteredClientRepository.findByClientId("client1");

		// 기존 클라이언트가 있으면 DB에서 직접 삭제
		if (client1 != null) {
			jdbcTemplate.update("DELETE FROM oauth2_registered_client WHERE client_id = ?", "client1");
		}

		RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString()).clientId("client1")
				.clientSecret(passwordEncoder.encode("1234")).clientSettings(clientSettings())
				.clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_POST)
				.clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
				.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
				.authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
				.authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
				.redirectUri("https://oidcdebugger.com/debug")
				.redirectUri("http://jcornor.com:8000/callback")
				.redirectUri("https://oauth.pstmn.io/v1/callback")
				.scope(OidcScopes.OPENID).scope("profiles")
				.scope("contacts").scope("messages").tokenSettings(tokenSettings()).build();

		jdbcRegisteredClientRepository.save(registeredClient);

		return jdbcRegisteredClientRepository;
	}

	/**
	 * AuthorizationService 설정
	 */
	@Bean
	OAuth2AuthorizationService authorizationService(JdbcTemplate jdbcTemplate,
			RegisteredClientRepository registeredClientRepository) {
		return new JdbcOAuth2AuthorizationService(jdbcTemplate, registeredClientRepository);
	}

	/**
	 * AuthorizationConsentService 설정
	 */
	@Bean
	OAuth2AuthorizationConsentService authorizationConsentService(JdbcTemplate jdbcTemplate,
			RegisteredClientRepository registeredClientRepository) {
		return new JdbcOAuth2AuthorizationConsentService(jdbcTemplate, registeredClientRepository);
	}
}



** 슬라이드 69

#server settings
server.port=8000

#data source settings
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

#JPA settings
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true



** 슬라이드 70

package com.multi.oauth20server.domain;
......

@Entity
public class Contact {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private long no;
  private String name;
  private String tel;
  private String address;

  //생성자, Getter, Setter 자동 생성할 것
}



** 슬라이드 71

package com.multi.oauth20server.dao;

import org.springframework.data.jpa.repository.JpaRepository;
import com.multi.oauth20server.domain.Contact;

public interface ContactRepository extends JpaRepository<Contact, Long>{
}



** 슬라이드 72

package com.multi.oauth20server;
......
@RestController
@RequestMapping(value="/api")
public class ContactController {  
  @Autowired
  ContactRepository contactRepository;

  @GetMapping(value="/contacts", produces = {"application/json"})
  public List<Contact> getContactList() {
    return contactRepository.findAll();
  }
  
  @GetMapping(value="/profiles", produces = {"application/json"})
  public HashMap<String, String> getProfile() {
    HashMap<String,String> profile = new HashMap<String, String>();
    profile.put("system", "OAuth 2.0 Resource Server");
    profile.put("devenv", "Spring Boot 3.x");
    return profile;
  }
}


** 슬라이드 74

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>  
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>

------
……
# Disable Servlet Context for H2 DB
spring.h2.console.enabled=false

# JWT Issuer Setting
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://tfactory.com


** 슬라이드 75

package com.multi.oauth20server;
......

@EnableWebSecurity
@Configuration
public class ResourceSecurityConfig {

	// 권한 검증 하지 않을 경로 지정
	@Bean
	WebSecurityCustomizer webSecurityCustomizer() {
		return (web) -> web.ignoring().requestMatchers("/webjars/**", "/assets/**");
	}

	/**
	 * * 권한 적용 - Swagger 관련 경로는 모두 허용 - /api/contacts : contacts SCOPE가 있어야 함 -
	 * /api/profiles : profiles SCOPE가 있어야 함 * OAuth2 Resource Server에 JWT 적용
	 */
	@Bean
	SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
		http.csrf(Customizer.withDefaults())
				.authorizeHttpRequests((authz) -> authz
			      .requestMatchers("/swagger/**", "/swagger-ui/**", "/swagger-ui.html", "/v3/api-docs/**").permitAll()
						.requestMatchers("/api/contacts").hasAuthority("SCOPE_contacts")
						.requestMatchers("/api/profiles").hasAuthority("SCOPE_profiles")
						.anyRequest().authenticated())
				.oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()));
		return http.build();
	}
}


** 슬라이드 80
package com.multi.oauth20server;
......
@RestController
@RequestMapping(value="/api")
public class ContactController {  
    ......

   @GetMapping(value="/userinfo") 
   public HashMap<String, String> getUserName(@AuthenticationPrincipal Jwt jwt) {
       HashMap<String, String> myinfo = new HashMap<String, String>();
       String username = jwt.getClaimAsString("sub");
       myinfo.put("userid", username);
       return myinfo;
   }
}































